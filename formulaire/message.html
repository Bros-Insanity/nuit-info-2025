<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Titre de Chevalier</title>
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <style>
    body {
      font-family: Georgia, serif;
      padding: 2em;
      background: #f9f7f3;
    }
    .message {
      border: 2px solid #333;
      padding: 2em;
      background: #fff;
      max-width: 800px;
      margin: auto;
      white-space: pre-wrap;
    }
    #blasonContainer svg {
      margin-top: 2em;
      width: 200px;
      height: 250px;
      border: 1px solid #000;
    }
  </style>
</head>
<body>
  <h1>ðŸ“œ Acte de nomination</h1>
  <div class="message" id="messageRSE"></div>
  <div id="blasonContainer"></div>
  <br>
  <button onclick="genererPDF()">ðŸ“¥ TÃ©lÃ©charger le diplÃ´me</button>

<script>
const params = new URLSearchParams(window.location.search);

function articleDe(word) {
  const startsWithVowel = /^[aeiouyhÃ¢ÃªÃ®Ã´Ã»Ã©Ã¨Ã«Ã¯Ã¼Å“Ã Ã¹]/i.test(word);
  return startsWithVowel ? "dâ€™" : "de ";
}

function hasParticle(nom) {
  return /^(de|du|des|dâ€™|d')\s?/i.test(nom.trim());
}

function nomAvecParticule(nom) {
  return hasParticle(nom) ? nom : articleDe(nom) + nom;
}

function accordeGenre(genre, base) {
  if (genre === "femme") return base + "e";
  if (genre === "non-binaire") return base + "Â·e";
  return base;
}

const genre = params.get("genre");
const genre1 = params.get("genre1");
const genre2 = params.get("genre2");
const prenom = params.get("prenom");
const nom = params.get("nom");
const parent1 = params.get("parent1");
const parent2 = params.get("parent2");
const residence = nomAvecParticule(params.get("residence"));
const naissanceVille = nomAvecParticule(params.get("naissanceVille"));
const pays = params.get("pays");

const ne = accordeGenre(genre, "nÃ©");
const aime = accordeGenre(genre1, "aimÃ©");
const respecte = accordeGenre(genre2, "respectÃ©");
const paysAvecArticle = articleDe(pays) + pays;
const comteNom = `${prenom} ${hasParticle(nom) ? nom : "de " + nom}, comte ${residence}`;

const message = `Cher comte ${prenom} Ier ${hasParticle(nom) ? nom : "de " + nom}, comte ${residence}, vassal du roi ${paysAvecArticle},
${ne} des Terres ${naissanceVille} le ${params.get("naissanceDate")},
fruit de lâ€™union de lâ€™${aime} ${parent1} et du ${respecte} ${parent2}.

Par les droits confÃ©rÃ©s par le Royaume des Informaticiens, moi, Andreas Ier de Mulard,
nÃ© sur le comtÃ© de Chambray-lÃ¨s-Tours, te confirme le titre de Chevalier de la RSE,
et la gloire quâ€™il incarne.`;

document.getElementById("messageRSE").textContent = message;

// Afficher blason SVG
const svgCode = params.get("blasonSvg");
if (svgCode && svgCode.includes("<svg")) {
  const decoded = decodeURIComponent(svgCode);
  document.getElementById("blasonContainer").innerHTML = decoded;
}

async function genererPDF() {
  const { PDFDocument, rgb, StandardFonts } = PDFLib;
  const pdfDoc = await PDFDocument.create();
  const times = await pdfDoc.embedFont(StandardFonts.TimesRoman);

  // PAGE 1
  const page1 = pdfDoc.addPage();
  page1.setFont(times);
  page1.setFontSize(12);
  const { width, height } = page1.getSize();
  page1.drawText(message, { x: 50, y: height - 80, size: 12, lineHeight: 16 });

  // PAGE 2 (paysage)
  const landscapeWidth = height;
  const landscapeHeight = width;
  const page2 = pdfDoc.addPage([landscapeWidth, landscapeHeight]);
  page2.setFont(times);
  page2.setFontSize(14);

  page2.drawText("SociÃ©tÃ© Chevaleresque des Programmeurs 37", {
    x: landscapeWidth / 2 - 180,
    y: landscapeHeight - 50
  });

  page2.drawText(`Est dÃ©livrÃ© Ã  ${comteNom}`, {
    x: 100,
    y: landscapeHeight - 120
  });

  page2.drawText("le rang de Chevalier de la RSE et les droits qui y sont liÃ©s", {
    x: 100,
    y: landscapeHeight - 150
  });

  page2.drawText(comteNom, {
    x: 50,
    y: 100
  });

  page2.drawText("Andreas Ier de Mulard", {
    x: landscapeWidth - 250,
    y: 100
  });

  // Blason utilisateur (SVG)
  if (svgCode && svgCode.includes("<svg")) {
    try {
      const svgImage = await pdfDoc.embedSvg(decodeURIComponent(svgCode), { width: 100, height: 100 });
      page2.drawImage(svgImage, { x: 50, y: 130, width: 100, height: 100 });
    } catch (e) {
      console.error("Erreur SVG:", e);
    }
  }

  // Logo officiel SCP37 (Ã  droite)
const logoUrl = "https://scp37.com/media/blason.png";

  const imageBytes = await fetch(logoUrl).then(res => res.arrayBuffer());
  const image = await pdfDoc.embedPng(imageBytes);
  page2.drawImage(image, {
    x: landscapeWidth - 150,
    y: 130,
    width: 100,
    height: 100
  });

  // TÃ©lÃ©charger le PDF
  const pdfBytes = await pdfDoc.save();
  const blob = new Blob([pdfBytes], { type: "application/pdf" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "diplome_chevalier.pdf";
  link.click();
}
</script>
</body>
</html>

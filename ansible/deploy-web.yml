---
- name: Deploy Web Container with Nginx
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    container_id: 30000
    container_name: "web-nuit-info"
    container_memory: 512
    container_cores: 1
    container_disk: 8
    container_ip: "10.0.0.20/24"
    container_gateway: "10.0.0.254"
    container_dns: "1.1.1.1"
    github_repo: "https://raw.githubusercontent.com/Bros-Insanity/nuit-info-2025/formulaire/test.html"

  tasks:
    # --- Suppression du container existant si present ---
    - name: Check if container exists
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/lxc/{{ container_id }}/status/current"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        validate_certs: no
        status_code: [200, 500]
      register: container_check
      ignore_errors: yes

    - name: Stop existing container
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/lxc/{{ container_id }}/status/stop"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        validate_certs: no
        status_code: [200, 202, 500]
      when: container_check.status == 200
      ignore_errors: yes

    - name: Wait for container to stop
      pause:
        seconds: 5
      when: container_check.status == 200

    - name: Delete existing container
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/lxc/{{ container_id }}"
        method: DELETE
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        validate_certs: no
        status_code: [200, 202, 500]
      when: container_check.status == 200
      ignore_errors: yes

    - name: Wait for container deletion
      pause:
        seconds: 5
      when: container_check.status == 200

    # --- Telechargement du template TurnKey avec nginx ---
    - name: Get current templates on storage
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/storage/local/content"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        validate_certs: no
      register: current_templates

    - name: Check if turnkey-nginx template exists
      set_fact:
        turnkey_nginx_exists: "{{ current_templates.json.data | selectattr('volid', 'search', 'turnkey-nginx') | list | length > 0 }}"

    - name: Download TurnKey nginx template
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/storage/local/download-url"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        body_format: form-urlencoded
        body:
          url: "http://mirror.turnkeylinux.org/turnkeylinux/images/proxmox/turnkey-nginx_18.0-1_amd64.tar.gz"
          content: "vztmpl"
          filename: "turnkey-nginx_18.0-1_amd64.tar.gz"
        validate_certs: no
        status_code: [200, 202]
      register: download_turnkey_nginx
      when: not turnkey_nginx_exists

    - name: Wait for turnkey-nginx template download
      pause:
        seconds: 90
      when: not turnkey_nginx_exists

    - name: Set template to use
      set_fact:
        existing_template:
          volid: "local:vztmpl/turnkey-nginx_18.0-1_amd64.tar.gz"

    # --- Creation du container avec IP fixe ---
    - name: Create LXC container with static IP
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/lxc"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        body_format: form-urlencoded
        body:
          vmid: "{{ container_id }}"
          hostname: "{{ container_name }}"
          ostemplate: "{{ existing_template.volid }}"
          storage: "data"
          memory: "{{ container_memory }}"
          cores: "{{ container_cores }}"
          rootfs: "data:{{ container_disk }}"
          net0: "name=eth0,bridge=vmbr0,ip={{ container_ip }},gw={{ container_gateway }}"
          nameserver: "{{ container_dns }}"
          unprivileged: 1
          start: 0
        validate_certs: no
        status_code: [200, 202]
      register: create_result

    - name: Wait for container filesystem to be ready
      pause:
        seconds: 5

    # --- Bypass TurnKey initialization (optionnel) ---
    # Les templates TurnKey necessitent une initialisation, mais on peut la bypasser
    # en creant le fichier de configuration d'initialisation
    - name: Bypass TurnKey initialization
      shell: |
        ssh -o StrictHostKeyChecking=no root@{{ proxmox_api_host }} "pct exec {{ container_id }} -- bash -c 'touch /etc/turnkey-init.done && echo \"root:root\" | chpasswd'"
      register: bypass_init
      ignore_errors: yes
      changed_when: false

    # --- Demarrage du container (nginx deja installe dans TurnKey) ---
    - name: Start container
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/lxc/{{ container_id }}/status/start"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        validate_certs: no
        status_code: [200, 202]
      register: start_result

    - name: Wait for container and nginx to be ready
      pause:
        seconds: 45

    # --- Deploiement du fichier test.html ---
    # Note: TurnKey nginx a deja nginx installe, on doit juste remplacer le contenu
    # On utilise l'API Proxmox pour executer des commandes via pct exec
    # Si SSH vers Proxmox n'est pas disponible, il faudra le faire manuellement
    - name: Deploy test.html via pct exec (requires SSH to Proxmox)
      shell: |
        ssh -o StrictHostKeyChecking=no root@{{ proxmox_api_host }} "pct exec {{ container_id }} -- curl -s -o /var/www/html/index.html {{ github_repo }}"
      register: deploy_file
      ignore_errors: yes
      changed_when: false

    - name: Restart nginx to apply changes
      shell: |
        ssh -o StrictHostKeyChecking=no root@{{ proxmox_api_host }} "pct exec {{ container_id }} -- systemctl restart nginx"
      register: restart_nginx
      ignore_errors: yes
      changed_when: false
      when: deploy_file.rc == 0

    - name: Display deployment status
      debug:
        msg: |
          Container {{ container_id }} ({{ container_name }}) deploye avec template TurnKey nginx!
          IP: {{ container_ip }}
          Gateway: {{ container_gateway }}
          DNS: {{ container_dns }}
          Web: http://10.0.0.20/
          {% if deploy_file.rc != 0 %}
          Note: Le fichier test.html doit etre deploye manuellement:
          Depuis Proxmox: pct exec {{ container_id }} -- curl -o /var/www/html/index.html {{ github_repo }}
          {% else %}
          Fichier test.html deploye avec succes!
          {% endif %}

    - name: Show result
      debug:
        msg: |
          Container {{ container_id }} ({{ container_name }}) deploye!
          IP: {{ container_ip }}
          Gateway: {{ container_gateway }}
          DNS: {{ container_dns }}
          Web: http://10.0.0.20/


---
- name: Create Debian Container
  hosts: localhost
  connection: local
  gather_facts: no

  vars:
    container_id: 30000
    container_name: "debian-test"
    container_memory: 512
    container_cores: 1
    container_disk: 8
    container_ip: "10.0.0.20/24"
    container_gateway: "10.0.0.254"
    container_dns: "1.1.1.1"
    github_repo: "Bros-Insanity/nuit-info-2025"
    # La branche peut être spécifiée via -e github_branch=winux-auto-deploy
    github_branch: "{{ github_branch | default('main') }}"

  tasks:
    - name: Check if container exists
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/lxc/{{ container_id }}/status/current"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        validate_certs: no
        status_code: [200, 500]
      register: container_check
      ignore_errors: yes

    - name: Stop existing container
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/lxc/{{ container_id }}/status/stop"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        validate_certs: no
        status_code: [200, 202, 500]
      when: container_check.status == 200
      ignore_errors: yes

    - name: Wait for container to stop
      pause:
        seconds: 5
      when: container_check.status == 200

    - name: Delete existing container
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/lxc/{{ container_id }}"
        method: DELETE
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        validate_certs: no
        status_code: [200, 202, 500]
      when: container_check.status == 200
      ignore_errors: yes

    - name: Wait for container deletion
      pause:
        seconds: 5
      when: container_check.status == 200

    - name: Get current templates on storage
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/storage/local/content"
        method: GET
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        validate_certs: no
      register: current_templates

    - name: Check if Debian standard template exists
      set_fact:
        debian_standard_exists: "{{ current_templates.json.data | selectattr('volid', 'search', 'debian-12-standard') | list | length > 0 }}"

    - name: Download Debian 12 standard template
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/storage/local/download-url"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        body_format: form-urlencoded
        body:
          url: "http://download.proxmox.com/images/system/debian-12-standard_12.7-1_amd64.tar.zst"
          content: "vztmpl"
          filename: "debian-12-standard_12.7-1_amd64.tar.zst"
        validate_certs: no
        status_code: [200, 202]
      register: download_template
      when: not debian_standard_exists

    - name: Wait for template download
      pause:
        seconds: 60
      when: not debian_standard_exists

    - name: Set template to use
      set_fact:
        existing_template:
          volid: "local:vztmpl/debian-12-standard_12.7-1_amd64.tar.zst"

    - name: Create LXC container with static IP
      uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/nodes/{{ proxmox_node }}/lxc"
        method: POST
        headers:
          Authorization: "PVEAPIToken={{ proxmox_api_user }}={{ proxmox_api_token_secret }}"
        body_format: form-urlencoded
        body:
          vmid: "{{ container_id }}"
          hostname: "{{ container_name }}"
          ostemplate: "{{ existing_template.volid }}"
          storage: "data"
          memory: "{{ container_memory }}"
          cores: "{{ container_cores }}"
          rootfs: "data:{{ container_disk }}"
          net0: "name=eth0,bridge=vmbr0,ip={{ container_ip }},gw={{ container_gateway }}"
          nameserver: "{{ container_dns }}"
          unprivileged: 1
          start: 1
        validate_certs: no
        status_code: [200, 202]
      register: create_result

    - name: Wait for container to be ready
      pause:
        seconds: 30

    - name: Create SSH key file from environment
      copy:
        content: |
          {{ proxmox_ssh_private_key }}
        dest: "/tmp/proxmox_ssh_key"
        mode: '0600'
      when: proxmox_ssh_private_key is defined
      ignore_errors: yes
      no_log: true

    - name: Validate SSH key format
      command: ssh-keygen -l -f /tmp/proxmox_ssh_key
      register: key_validation
      ignore_errors: yes
      changed_when: false
      when: proxmox_ssh_private_key is defined

    - name: Show key validation result
      debug:
        msg: "Key validation: {{ key_validation.stdout if key_validation.rc == 0 else 'INVALID - ' + key_validation.stderr }}"
      when: proxmox_ssh_private_key is defined

    - name: Test SSH connection to Proxmox
      shell: |
        ssh -i {{ proxmox_ssh_key_path | default('/tmp/proxmox_ssh_key') }} -o StrictHostKeyChecking=no -o ConnectTimeout=5 root@{{ proxmox_api_host }} "echo 'SSH OK'"
      register: ssh_test
      ignore_errors: yes
      changed_when: false
      when: proxmox_ssh_private_key is defined

    - name: Show SSH test result
      debug:
        msg: "SSH test result: {{ ssh_test.stdout if (ssh_test.rc == 0 and proxmox_ssh_private_key is defined) else 'SSH key not configured or connection failed' }}"

    - name: Install nginx, curl and git via pct exec
      shell: |
        ssh -i {{ proxmox_ssh_key_path | default('/tmp/proxmox_ssh_key') }} -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@{{ proxmox_api_host }} "pct exec {{ container_id }} -- bash -c 'export DEBIAN_FRONTEND=noninteractive && apt-get update && apt-get install -y nginx curl git'"
      register: install_nginx
      ignore_errors: yes
      changed_when: install_nginx.rc == 0
      when: proxmox_ssh_private_key is defined

    - name: Set deploy branch
      set_fact:
        deploy_branch: "{{ github_branch | default('main') }}"

    - name: Deploy public directory via git clone
      shell: |
        ssh -i {{ proxmox_ssh_key_path | default('/tmp/proxmox_ssh_key') }} -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@{{ proxmox_api_host }} "pct exec {{ container_id }} -- bash -c 'set -e && cd /tmp && rm -rf nuit-info-2025 && git clone --depth 1 --branch {{ deploy_branch }} https://github.com/{{ github_repo }}.git && rm -rf /var/www/html/* /var/www/html/.* 2>/dev/null || true && mkdir -p /var/www/html/contact /var/www/html/diplome /var/www/html/winux && cp -r nuit-info-2025/public/css /var/www/html/ && cp -r nuit-info-2025/public/js /var/www/html/ && cp -r nuit-info-2025/public/html/contact/* /var/www/html/contact/ && cp -r nuit-info-2025/public/html/diplome/* /var/www/html/diplome/ && if [ -d \"nuit-info-2025/public/html/winux\" ]; then cp -r nuit-info-2025/public/html/winux/* /var/www/html/winux/; fi && cp nuit-info-2025/public/html/index.html /var/www/html/index.html && mkdir -p /opt && cp -r nuit-info-2025 /opt/ && chown -R www-data:www-data /var/www/html && chmod 755 /var/www/html && chmod -R 644 /var/www/html/* && find /var/www/html -type d -exec chmod 755 {} \; && find /var/www/html -type f -exec chmod 644 {} \; && echo \"=== Deployment complete ===\" && echo \"=== Files in /var/www/html ===\" && ls -la /var/www/html && if [ -d \"/var/www/html/winux\" ]; then echo \"=== Files in /var/www/html/winux ===\" && ls -la /var/www/html/winux; fi && rm -rf /tmp/nuit-info-2025'"
      register: deploy_files
      ignore_errors: yes
      changed_when: deploy_files.rc == 0
      when: install_nginx.rc == 0 and proxmox_ssh_private_key is defined

    - name: Verify deployed files
      shell: |
        ssh -i {{ proxmox_ssh_key_path | default('/tmp/proxmox_ssh_key') }} -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@{{ proxmox_api_host }} "pct exec {{ container_id }} -- bash -c 'echo \"=== Files in /var/www/html ===\" && ls -la /var/www/html && echo \"=== Files in /var/www/html/contact ===\" && ls -la /var/www/html/contact 2>/dev/null || echo \"contact directory not found\" && echo \"=== Files in /var/www/html/diplome ===\" && ls -la /var/www/html/diplome 2>/dev/null || echo \"diplome directory not found\"'"
      register: verify_files
      ignore_errors: yes
      when: deploy_files is defined and deploy_files.rc == 0 and proxmox_ssh_private_key is defined

    - name: Show verification result
      debug:
        msg: "{{ verify_files.stdout if (verify_files is defined and verify_files.rc is defined and verify_files.rc == 0) else 'Verification failed or skipped' }}"
      when: verify_files is defined and verify_files.rc is defined and verify_files.rc == 0

    - name: Configurer nginx pour proxy l'API Winux
      shell: |
        ssh -i {{ proxmox_ssh_key_path | default('/tmp/proxmox_ssh_key') }} \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            root@{{ proxmox_api_host }} \
            "pct exec {{ container_id }} -- bash -c 'echo \"server {\" > /etc/nginx/sites-available/default && \
            echo \"    listen 80 default_server;\" >> /etc/nginx/sites-available/default && \
            echo \"    listen [::]:80 default_server;\" >> /etc/nginx/sites-available/default && \
            echo \"    root /var/www/html;\" >> /etc/nginx/sites-available/default && \
            echo \"    index index.html;\" >> /etc/nginx/sites-available/default && \
            echo \"    server_name _;\" >> /etc/nginx/sites-available/default && \
            echo \"    location / {\" >> /etc/nginx/sites-available/default && \
            echo \"        try_files \\\\\$uri \\\\\$uri/ =404;\" >> /etc/nginx/sites-available/default && \
            echo \"    }\" >> /etc/nginx/sites-available/default && \
            echo \"    location /api/winux {\" >> /etc/nginx/sites-available/default && \
            echo \"        proxy_pass http://localhost:5000;\" >> /etc/nginx/sites-available/default && \
            echo \"        proxy_set_header Host \\\\\$host;\" >> /etc/nginx/sites-available/default && \
            echo \"        proxy_set_header X-Real-IP \\\\\$remote_addr;\" >> /etc/nginx/sites-available/default && \
            echo \"        proxy_set_header X-Forwarded-For \\\\\$proxy_add_x_forwarded_for;\" >> /etc/nginx/sites-available/default && \
            echo \"        proxy_set_header X-Forwarded-Proto \\\\\$scheme;\" >> /etc/nginx/sites-available/default && \
            echo \"        proxy_connect_timeout 60s;\" >> /etc/nginx/sites-available/default && \
            echo \"        proxy_send_timeout 60s;\" >> /etc/nginx/sites-available/default && \
            echo \"        proxy_read_timeout 60s;\" >> /etc/nginx/sites-available/default && \
            echo \"    }\" >> /etc/nginx/sites-available/default && \
            echo \"    location /winux {\" >> /etc/nginx/sites-available/default && \
            echo \"        alias /var/www/html/winux;\" >> /etc/nginx/sites-available/default && \
            echo \"        try_files \\\\\$uri \\\\\$uri/ /winux/index.html;\" >> /etc/nginx/sites-available/default && \
            echo \"    }\" >> /etc/nginx/sites-available/default && \
            echo \"}\" >> /etc/nginx/sites-available/default && \
            rm -f /etc/nginx/sites-enabled/default && \
            ln -s /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default'"
      register: configure_nginx
      ignore_errors: yes
      changed_when: configure_nginx.rc == 0
      when: install_nginx.rc == 0 and proxmox_ssh_private_key is defined

    - name: Tester la configuration nginx
      shell: |
        ssh -i {{ proxmox_ssh_key_path | default('/tmp/proxmox_ssh_key') }} \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            root@{{ proxmox_api_host }} \
            "pct exec {{ container_id }} -- nginx -t"
      register: nginx_test
      ignore_errors: yes
      when: configure_nginx.rc == 0 and proxmox_ssh_private_key is defined

    - name: Enable and start nginx via pct exec
      shell: |
        ssh -i {{ proxmox_ssh_key_path | default('/tmp/proxmox_ssh_key') }} -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@{{ proxmox_api_host }} "pct exec {{ container_id }} -- systemctl enable --now nginx"
      register: start_nginx
      ignore_errors: yes
      changed_when: start_nginx.rc == 0
      when: install_nginx.rc == 0 and proxmox_ssh_private_key is defined

    - name: Installer Python3 et pip dans le container
      shell: |
        ssh -i {{ proxmox_ssh_key_path | default('/tmp/proxmox_ssh_key') }} \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            root@{{ proxmox_api_host }} \
            "pct exec {{ container_id }} -- bash -c 'export DEBIAN_FRONTEND=noninteractive && apt-get update && apt-get install -y python3 python3-pip python3-venv'"
      register: install_python
      ignore_errors: yes
      changed_when: install_python.rc == 0
      when: install_nginx.rc == 0 and proxmox_ssh_private_key is defined

    - name: Installer les dépendances Python pour l'API Winux
      shell: |
        ssh -i {{ proxmox_ssh_key_path | default('/tmp/proxmox_ssh_key') }} \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            root@{{ proxmox_api_host }} \
            "pct exec {{ container_id }} -- bash -c 'cd /opt/nuit-info-2025 && pip3 install -r requirements_winux.txt'"
      register: install_api_deps
      ignore_errors: yes
      changed_when: install_api_deps.rc == 0
      when: install_python.rc == 0 and deploy_files.rc == 0 and proxmox_ssh_private_key is defined

    - name: Créer le service systemd pour l'API Winux
      shell: |
        ssh -i {{ proxmox_ssh_key_path | default('/tmp/proxmox_ssh_key') }} \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            root@{{ proxmox_api_host }} \
            "pct exec {{ container_id }} -- bash -c 'printf \"[Unit]\\nDescription=API Winux Flask\\nAfter=network.target\\n\\n[Service]\\nType=simple\\nUser=root\\nWorkingDirectory=/opt/nuit-info-2025\\nEnvironment=\\\"PATH=/usr/bin:/usr/local/bin\\\"\\nExecStart=/usr/bin/python3 /opt/nuit-info-2025/api_winux.py\\nRestart=always\\nRestartSec=10\\n\\n[Install]\\nWantedBy=multi-user.target\\n\" > /etc/systemd/system/winux-api.service'"
      register: create_api_service
      ignore_errors: yes
      changed_when: create_api_service.rc == 0
      when: install_api_deps.rc == 0 and proxmox_ssh_private_key is defined

    - name: Recharger systemd et démarrer l'API Winux
      shell: |
        ssh -i {{ proxmox_ssh_key_path | default('/tmp/proxmox_ssh_key') }} \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            root@{{ proxmox_api_host }} \
            "pct exec {{ container_id }} -- bash -c 'systemctl daemon-reload && systemctl enable --now winux-api'"
      register: start_api_service
      ignore_errors: yes
      changed_when: start_api_service.rc == 0
      when: create_api_service.rc == 0 and proxmox_ssh_private_key is defined

    - name: Vérifier le statut de l'API Winux
      shell: |
        ssh -i {{ proxmox_ssh_key_path | default('/tmp/proxmox_ssh_key') }} \
            -o StrictHostKeyChecking=no \
            -o ConnectTimeout=10 \
            root@{{ proxmox_api_host }} \
            "pct exec {{ container_id }} -- systemctl status winux-api --no-pager -l"
      register: api_status
      ignore_errors: yes
      when: start_api_service.rc == 0 and proxmox_ssh_private_key is defined

    - name: Show result
      debug:
        msg: |
          Container {{ container_id }} ({{ container_name }}) cree avec succes!
          IP: {{ container_ip }}
          Gateway: {{ container_gateway }}
          DNS: {{ container_dns }}
          Web: http://10.0.0.20/
          {% if install_nginx.rc == 0 %}
          Nginx installe et site web deploye avec succes!
          {% else %}
          Note: Installation nginx necessite un acces SSH au serveur Proxmox ({{ proxmox_api_host }})
          {% endif %}
          {% if start_api_service.rc == 0 %}
          API Winux installee et demarree avec succes!
          API accessible sur: http://localhost:5000/api/winux
          {% else %}
          Note: Installation API Winux necessite un acces SSH au serveur Proxmox ({{ proxmox_api_host }})
          {% endif %}
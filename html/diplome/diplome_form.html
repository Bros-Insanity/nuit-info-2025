<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Formulaire complet avec accents et email</title>
  <link rel="stylesheet" href="../../css/blason.css">

  <script src="../../js/countries.js"></script>

</head>
<body>

<h1>Formulaire</h1>

<form id="mainForm" onsubmit="redirectToMessage(event)">

  <h2>Identité</h2>

  <div>
    <label>Genre :</label>
    <label><input type="radio" name="genrePers" value="Homme"> Homme</label>
    <label><input type="radio" name="genrePers" value="Femme"> Femme</label>
    <label><input type="radio" name="genrePers" value="Non-binaire"> Non-binaire</label>
  </div>

  <div>
    <label>Prénom :</label>
    <input type="text" id="prenom" readonly>
    <button type="button" data-compose="prenom">Composer</button>
    <button type="button" data-clear="prenom">Effacer</button>
  </div>

  <div>
    <label>Nom :</label>
    <input type="text" id="nom" readonly>
    <button type="button" data-compose="nom">Composer</button>
    <button type="button" data-clear="nom">Effacer</button>
  </div>

  <div>
    <label>Email :</label>
    <input type="text" id="email" readonly>
    <button type="button" data-compose="email">Composer</button>
    <button type="button" data-clear="email">Effacer</button>
  </div>

  <h2>Villes</h2>

  <div>
    <label>Ville de naissance :</label>
    <input type="text" id="villeN" readonly>
    <button type="button" data-compose="villeN">Composer</button>
    <button type="button" data-clear="villeN">Effacer</button>
  </div>

  <div>
    <label>Ville de résidence :</label>
    <input type="text" id="villeR" readonly>
    <button type="button" data-compose="villeR">Composer</button>
    <button type="button" data-clear="villeR">Effacer</button>
  </div>

  <h2>Parents</h2>

  <div>
    <label>Genre parent 1 :</label>
    <label><input type="radio" name="genreP1" value="Homme"> Homme</label>
    <label><input type="radio" name="genreP1" value="Femme"> Femme</label>
    <label><input type="radio" name="genreP1" value="Non-binaire"> Non-binaire</label>
  </div>

  <div>
    <label>Nom parent 1 :</label>
    <input type="text" id="parent1" readonly>
    <button type="button" data-compose="parent1">Composer</button>
    <button type="button" data-clear="parent1">Effacer</button>
  </div>

  <div>
    <label>Genre parent 2 :</label>
    <label><input type="radio" name="genreP2" value="Homme" > Homme</label>
    <label><input type="radio" name="genreP2" value="Femme"> Femme</label>
    <label><input type="radio" name="genreP2" value="Non-binaire"> Non-binaire</label>
  </div>

  <div>
    <label>Nom parent 2 :</label>
    <input type="text" id="parent2" readonly>
    <button type="button" data-compose="parent2">Composer</button>
    <button type="button" data-clear="parent2">Effacer</button>
  </div>

  <h2>Pays</h2>
  <div>
    <label>Vivez-vous dans l'Empire romain ?</label>
    <label><input type="radio" name="empire" value="oui"> Oui</label>
    <label><input type="radio" name="empire" value="non" checked> Non</label>
  </div>
  <div>
    <label>Pays :</label>
    <select id="pays"></select>
  </div>

  <h2>Date de naissance (calendrier républicain)</h2>
  <div>
    <label>Année :</label>
    <input type="number" id="repYear" min="1" max="400">
  </div>
  <div>
    <label>Mois :</label>
    <select id="repMonth">
      <option>Vendémiaire</option><option>Brumaire</option><option>Frimaire</option>
      <option>Nivôse</option><option>Pluviôse</option><option>Ventôse</option>
      <option>Germinal</option><option>Floréal</option><option>Prairial</option>
      <option>Messidor</option><option>Thermidor</option><option>Fructidor</option>
      <option>Sans-culottides</option>
    </select>
  </div>
  <div>
    <label>Jour :</label>
    <select id="repDay"></select>
  </div>

<h2>Blason</h2>
  <div id="blason"></div>
  <p id="blasonDesc"></p>
  <button type="button" id="generate">Générer un blason</button>

<hr>
<button type="submit">Envoyer</button>

</form>

<!-- Mot Picker -->
<div id="wordPicker" style="display:none;">
  <h3>Choisissez un mot :</h3>
  <div id="wordGrid"></div>
  <button id="closePicker">Fermer</button>
</div>

<script>
const wordPool = {
  A:["Ananas","Astéroïde"], B:["Banane","Bateau"], C:["Cactus","Crabe"],
  D:["Dauphin","Dragon"], E:["Escargot","Éléphant"], F:["Fraise","Fusée"],
  G:["Galet","Guitare"], H:["Hibou","Hache"], I:["Igloo","Iris"],
  J:["Jasmin","Jungle"], K:["Koala","Kiwi"], L:["Lama","Lune"],
  M:["Mangue","Montagne"], N:["Navet","Nuage"], O:["Orange","Océan"],
  P:["Pomme","Panda"], Q:["Quiche","Quartz"], R:["Robot","Rivière"],
  S:["Soleil","Salade"], T:["Tulipe","Tigre"], U:["Uniforme","Urne"],
  V:["Vache","Vélo"], W:["Wifi","Wasabi"], X:["Xylophone","Xénon"],
  Y:["Yaourt","Yéti"], Z:["Zèbre","Zéro"],
  "@": ["@"], ".": ["."], "-": ["-"],"'": ["'"],
  "é": ["é"], "è": ["è"], "ê": ["ê"], "ë": ["ë"],
  "à": ["à"], "â": ["â"], "ä": ["ä"], "ô": ["ô"], "ö": ["ö"],
  "î": ["î"], "ï": ["ï"], "ù": ["ù"], "û": ["û"], "ç": ["ç"]
};

const picker = document.getElementById("wordPicker");
const grid = document.getElementById("wordGrid");
const closeBtn = document.getElementById("closePicker");
let currentField = null;

function capitalizeSmart(text){
  return text
    .toLowerCase()
    .replace(/(^|\s|-)(\S)/g, (m,p1,p2) => p1 + p2.toUpperCase());
}

function openPicker(fieldId){
  currentField = document.getElementById(fieldId);
  renderGrid();
  picker.style.display = "block";
}

function renderGrid(){
  grid.innerHTML = "";
  for (let key in wordPool){
    const words = wordPool[key];
    const word = words[Math.floor(Math.random() * words.length)];
    const btn = document.createElement("button");
    btn.textContent = word;
	btn.onclick = () => {
	  if (!currentField) return;
	  const char = key; // Le caractère-clé
	  if (currentField.id === "email") {
		currentField.value += char.toLowerCase();
	  } else {
		currentField.value += char.length === 1 ? char : key;
		currentField.value = capitalizeSmart(currentField.value);
	  }
	};
    grid.appendChild(btn);
  }
}

closeBtn.onclick = () => {
  picker.style.display = "none";
  currentField = null;
};

document.querySelectorAll("[data-compose]").forEach(btn=>{
  btn.onclick = () => openPicker(btn.dataset.compose);
});

document.querySelectorAll("[data-clear]").forEach(btn=>{
  btn.onclick = () => {
    const field = document.getElementById(btn.dataset.clear);
    if (field) field.value = "";
  };
});



const paysSelect = document.getElementById("pays");

function updateCountries(){
  const isRoman = document.querySelector("input[name='empire']:checked").value === "oui";
  paysSelect.innerHTML = "";
  if (isRoman){
    provinces.forEach(p=>{
      const opt = document.createElement("option");
      opt.textContent = p;
      paysSelect.appendChild(opt);
    });
  } else {
    countries.forEach(c=>{
      const opt = document.createElement("option");
      opt.textContent = c.flag;
      opt.title = c.name;
	  opt.value = c.name;
      paysSelect.appendChild(opt);
    });
  }
}
document.querySelectorAll("input[name='empire']").forEach(r=>r.onchange=updateCountries);
updateCountries();

// Date
const repMonth = document.getElementById("repMonth");
const repDay = document.getElementById("repDay");
function updateDays(){
  const m = repMonth.value;
  const max = m === "Sans-culottides" ? 5 : 30;
  repDay.innerHTML = "";
  for (let i=1;i<=max;i++){
    const opt = document.createElement("option");
    opt.textContent = i;
    repDay.appendChild(opt);
  }
}
repMonth.onchange = updateDays;
updateDays();

</script>


  <script>
    const tinctures = ['argent', 'or', 'gules', 'azure', 'vert', 'sable', 'purpure'];
    const tinctureColors = {
      argent: '#f8f8f8',
      or: '#ffd700',
      gules: '#e60026',
      azure: '#0033a0',
      vert: '#228b22',
      sable: '#000000',
      purpure: '#660099'
    };
    const divisions = ['per pale', 'per fess', 'plain'];
    const charges = ['circle', 'cross', 'star', 'diamond'];

    function generateBlazon() {
      const field = divisions[Math.floor(Math.random() * divisions.length)];
      let t1 = tinctures[Math.floor(Math.random() * tinctures.length)];
      let t2 = tinctures[Math.floor(Math.random() * tinctures.length)];
      while (t1 === t2) t2 = tinctures[Math.floor(Math.random() * tinctures.length)];
      const charge = charges[Math.floor(Math.random() * charges.length)];
      return { field, t1, t2, charge };
    }

    function drawBlazon(blazon) {
      const svgNS = "http://www.w3.org/2000/svg";
      const svg = document.createElementNS(svgNS, "svg");
      svg.setAttribute("viewBox", "0 0 200 250");

      // fond
      if (blazon.field === 'plain') {
        const rect = document.createElementNS(svgNS, "rect");
        rect.setAttribute("width", "200");
        rect.setAttribute("height", "250");
        rect.setAttribute("fill", tinctureColors[blazon.t1]);
        svg.appendChild(rect);
      } else if (blazon.field === 'per pale') {
        const left = document.createElementNS(svgNS, "rect");
        left.setAttribute("x", "0");
        left.setAttribute("y", "0");
        left.setAttribute("width", "100");
        left.setAttribute("height", "250");
        left.setAttribute("fill", tinctureColors[blazon.t1]);
        svg.appendChild(left);

        const right = document.createElementNS(svgNS, "rect");
        right.setAttribute("x", "100");
        right.setAttribute("y", "0");
        right.setAttribute("width", "100");
        right.setAttribute("height", "250");
        right.setAttribute("fill", tinctureColors[blazon.t2]);
        svg.appendChild(right);
      } else if (blazon.field === 'per fess') {
        const top = document.createElementNS(svgNS, "rect");
        top.setAttribute("x", "0");
        top.setAttribute("y", "0");
        top.setAttribute("width", "200");
        top.setAttribute("height", "125");
        top.setAttribute("fill", tinctureColors[blazon.t1]);
        svg.appendChild(top);

        const bottom = document.createElementNS(svgNS, "rect");
        bottom.setAttribute("x", "0");
        bottom.setAttribute("y", "125");
        bottom.setAttribute("width", "200");
        bottom.setAttribute("height", "125");
        bottom.setAttribute("fill", tinctureColors[blazon.t2]);
        svg.appendChild(bottom);
      }

      // charge
      const shape = document.createElementNS(svgNS, "path");
      shape.setAttribute("fill", "#fff");

      switch (blazon.charge) {
        case 'circle':
          shape.setAttribute("d", "M 100 125 m -30 0 a 30 30 0 1 0 60 0 a 30 30 0 1 0 -60 0");
          break;
        case 'cross':
          shape.setAttribute("d", "M90 90 H110 V110 H130 V130 H110 V150 H90 V130 H70 V110 H90 Z");
          break;
        case 'star':
          shape.setAttribute("d", "M100,75 L110,110 L145,110 L115,130 L125,165 L100,145 L75,165 L85,130 L55,110 L90,110 Z");
          break;
        case 'diamond':
          shape.setAttribute("d", "M100,80 L130,125 L100,170 L70,125 Z");
          break;
      }

      svg.appendChild(shape);

      const container = document.getElementById("blason");
      container.innerHTML = "";
      container.appendChild(svg);

		const traductionField = {
		  'plain': 'plein',
		  'per pale': 'coupé verticalement',
		  'per fess': 'coupé horizontalement'
		};
		const traductionTinctures = {
		  argent: 'argent', or: 'or', gules: 'gueules', azure: 'azur',
		  vert: 'sinople', sable: 'sable', purpure: 'pourpre'
		};
		const traductionCharges = {
		  circle: 'rond', cross: 'croix', star: 'étoile', diamond: 'losange'
		};

		document.getElementById("blasonDesc").textContent =
		  `Champ : ${traductionField[blazon.field]}, Émaux : ${traductionTinctures[blazon.t1]} & ${traductionTinctures[blazon.t2]}, Figure : ${traductionCharges[blazon.charge]}`;

    }

    document.getElementById("generate").onclick = () => {
      const b = generateBlazon();
      drawBlazon(b);
    };

    // generate at load
    window.onload = () => {
      const b = generateBlazon();
      drawBlazon(b);
    };
  </script>
<script>
function redirectToMessage(event) {
  event.preventDefault(); // empêche l'envoi normal du formulaire

  // sérialiser le blason SVG
  const svg = document.querySelector("#blason svg");
  let svgEncoded = "";
  if (svg) {
    const serializer = new XMLSerializer();
    const svgString = serializer.serializeToString(svg);
    svgEncoded = encodeURIComponent(svgString);
  }
    const genre = document.querySelector("input[name='genrePers']:checked")?.value || "";
  const genre1 = document.querySelector("input[name='genreP1']:checked")?.value || "";
  const genre2 = document.querySelector("input[name='genreP2']:checked")?.value || "";


  // récupérer les champs
const data = {
  prenom: document.getElementById("prenom").value,
  nom: document.getElementById("nom").value,
  residence: document.getElementById("villeR").value,
  pays: document.getElementById("pays").value,
  naissanceVille: document.getElementById("villeN").value,
  naissanceDate: document.getElementById("repDay").value + " " +
                  document.getElementById("repMonth").value + " an " +
                  document.getElementById("repYear").value,
  parent1: document.getElementById("parent1").value,
  parent2: document.getElementById("parent2").value,
    genre: genre,
    genre1: genre1,
    genre2: genre2,
  blasonSvg: svgEncoded
};


  // convertir en query string et rediriger
  const query = new URLSearchParams(data).toString();
  window.location.href = `message.html?${query}`;
}
</script>

</body>
</html>

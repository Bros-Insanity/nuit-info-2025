version: v1.0
name: Winux API - D√©ploiement Docker
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

blocks:
  - name: Build Docker Image
    task:
      jobs:
        - name: Build Winux API Image
          commands:
            - checkout
            - echo "üî® Construction de l'image Docker Winux API..."
            - docker build -t winux-api:latest -f Dockerfile .
            - echo "‚úÖ Image construite avec succ√®s"
            - docker images | grep winux-api

  - name: Test API Health
    task:
      jobs:
        - name: Test API Container
          commands:
            - checkout
            - echo "üß™ Test de l'API dans un container..."
            - |
              docker run -d \
                --name winux-api-test \
                -p 127.0.0.1:5001:5000 \
                -e NODE_ENV=production \
                -e PORT=5000 \
                -e HOST=0.0.0.0 \
                winux-api:latest
            - sleep 5
            - |
              if curl -f http://localhost:5001/api/winux/health; then
                echo "‚úÖ API r√©pond correctement"
              else
                echo "‚ùå API ne r√©pond pas"
                docker logs winux-api-test
                exit 1
              fi
            - docker stop winux-api-test
            - docker rm winux-api-test
            - echo "‚úÖ Tests r√©ussis"

  - name: Deploy to Server
    task:
      secrets:
        - name: proxmox-ssh-key
        - name: proxmox-host
      jobs:
        - name: Deploy Winux API Container
          commands:
            - checkout
            - echo "üöÄ D√©ploiement de l'API Winux sur le serveur..."
            - |
              # Cr√©er le r√©pertoire de travail sur le serveur
              ssh -i ~/.ssh/proxmox_key -o StrictHostKeyChecking=no root@${PROXMOX_HOST} \
                "mkdir -p /opt/winux-api"
            - |
              # Copier les fichiers n√©cessaires
              scp -i ~/.ssh/proxmox_key -o StrictHostKeyChecking=no \
                Dockerfile \
                docker-compose.yml \
                api_winux.js \
                package.json \
                root@${PROXMOX_HOST}:/opt/winux-api/
            - |
              # Arr√™ter et supprimer l'ancien container s'il existe
              ssh -i ~/.ssh/proxmox_key -o StrictHostKeyChecking=no root@${PROXMOX_HOST} \
                "cd /opt/winux-api && \
                 docker-compose down 2>/dev/null || true && \
                 docker rm -f winux-api 2>/dev/null || true"
            - |
              # Construire et d√©marrer le nouveau container
              ssh -i ~/.ssh/proxmox_key -o StrictHostKeyChecking=no root@${PROXMOX_HOST} \
                "cd /opt/winux-api && \
                 docker-compose build && \
                 docker-compose up -d"
            - |
              # V√©rifier que le container tourne
              ssh -i ~/.ssh/proxmox_key -o StrictHostKeyChecking=no root@${PROXMOX_HOST} \
                "sleep 5 && \
                 docker ps | grep winux-api && \
                 (curl -f http://localhost:5000/api/winux/health || wget -q -O- http://localhost:5000/api/winux/health) && \
                 echo '‚úÖ API d√©ploy√©e et op√©rationnelle'"
            - echo "‚úÖ D√©ploiement termin√© avec succ√®s"

